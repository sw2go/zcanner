<!doctype html>
<html lang="en">

  <head>
    <link>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="sw2go">
    <title>Scanner</title>
    <link rel="stylesheet" href="./style.css" />
  </head>

  <body>
    <input type="text" class="scan-result" id="scanResult"   >
    <!--
    <pre class="scan-result"><code id="scanResult"></code></pre>
    -->
      <!-- Trigger/Open The Modal -->
    <button id="scanButton">Scan</button>

    <!-- The Modal -->
    <div id="scanModal" class="modal">
      <!-- Modal content -->
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="sourceSelectPanel" style="display:none">
          <label for="sourceSelect">Change video source:</label>
          <select id="sourceSelect" >
          </select>
        </div>
        <div>
          <video id="video" width="100%" style="border: 1px solid gray"></video>
        </div>
      </div>
    </div>

    <main class="wrapper" style="padding-top:2em">

      <section class="container" id="demo-content">

      </section>

      <footer class="footer">
      </footer>

    </main>
  <!--
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
  -->
    <script type="text/javascript" src="script.js"></script>
    <script type="text/javascript" src="zxing.min.js"></script>
    <script type="text/javascript">
      window.addEventListener('load', function () {

        // Get the modal
        var modal = document.getElementById("scanModal");

        // Get the button that opens the modal
        var scanButton = document.getElementById("scanButton");

        var scanResult = document.getElementById('scanResult');

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        let selectedDeviceId;
        const codeReader = new ZXing.BrowserMultiFormatReader()
        console.log('ZXing code reader initialized')
        codeReader.getVideoInputDevices()
          .then((videoInputDevices) => {
            const sourceSelect = document.getElementById('sourceSelect')
            selectedDeviceId = videoInputDevices[0].deviceId
            console.log(`${videoInputDevices.length} video input(s) available`);
            if (videoInputDevices.length >= 1) {           
              videoInputDevices.forEach((element) => {
                const sourceOption = document.createElement('option')
                sourceOption.text = element.label
                sourceOption.value = element.deviceId
                sourceSelect.appendChild(sourceOption)
              })

              sourceSelect.onchange = () => {
                selectedDeviceId = sourceSelect.value;
              };

              const sourceSelectPanel = document.getElementById('sourceSelectPanel')
              sourceSelectPanel.style.display = 'block'

              // When the user clicks on the button, open the modal
              scanButton.onclick = function() {
                console.log("start scanner");
                scanResult.value = '';
                modal.style.display = "block";
                scanButton.style.display = "none";
                codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                  if (result) {
                    console.log(result);
                    scanResult.value = result.text;
                    stopScanner();
                  }
                  if (err && !(err instanceof ZXing.NotFoundException)) {
                    console.error(err)
                    scanResult.value = err
                    stopScanner();
                  }
                });
                console.log(`Started continous decode from camera with id ${selectedDeviceId}`);
              };

              // When the user clicks on <span> (x), close the modal
              span.onclick = function() {
                stopScanner();
              };

              // When the user clicks anywhere outside of the modal, close it
              window.onclick = function(event) {
                if (event.target == modal) {
                  stopScanner();
                }
              };

              function stopScanner() {
                console.log("stop scanner");
                modal.style.display = "none";
                scanButton.style.display = "inline";
                codeReader.reset();
              };
            };
          })
          .catch((err) => {
            console.error(err)
          });
      });
    </script>

  </body>

</html>